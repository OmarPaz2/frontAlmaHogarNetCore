@model AlmaHogarFront.DTO.VentaDTO

@{
    var promociones = ViewBag.Promociones as List<AlmaHogarFront.DTO.PromocionDTO>;
    var productosFiltrados = ViewBag.prodFiltrados as List<AlmaHogarFront.Models.Producto>;
    var listaProd = ViewBag.ListaProd as List<AlmaHogarFront.Models.ProductoVM>;
}

<div class="container mt-4">
    <!-- Búsqueda de Productos -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>Buscar Productos</h4>
        </div>
        <div class="card-body">
            <form asp-action="Index" method="get">
                <div class="input-group" style="max-width: 400px;">
                    <input type="text"
                           name="nombre"
                           class="form-control"
                           placeholder="Nombre del producto..."
                           value="@ViewData["CurrentFilter"]" />
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Productos Disponibles -->
    @if (productosFiltrados == null || !productosFiltrados.Any())
    {
        <div class="alert alert-info" role="alert">
            <strong>ℹ️</strong> No se encontraron productos. Intenta con otra búsqueda.
        </div>
    }
    else
    {
        <div class="card mb-4">
            <div class="card-header">
                <h4>Productos Disponibles</h4>
            </div>
            <div class="card-body table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>Stock</th>
                            <th>Cantidad</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in productosFiltrados)
                        {
                            <tr>
                                <td>
                                    <code>@item.codigo</code>
                                </td>
                                <td>
                                    <strong>@item.nombre</strong>
                                </td>
                                <td>
                                    S/. @item.precio.ToString("F2")
                                </td>
                                <td>
                                    <span class="badge bg-@(item.stock > 10 ? "success" : item.stock > 0 ? "warning" : "danger")">
                                        @item.stock unidades
                                    </span>
                                </td>
                                <td>
                                    <form asp-action="Agregar" method="post" style="display: inline;">
                                        <input type="hidden" name="codigo" value="@item.codigo" />
                                        <input type="hidden" name="nombre" value="@item.nombre" />
                                        <input type="hidden" name="precio" value="@item.precio" />

                                        <div class="input-group" style="width: 120px;">
                                            <input type="number"
                                                   name="cantidad"
                                                   class="form-control"
                                                   min="1"
                                                   max="@item.stock"
                                                   value="1" />
                                            <button type="submit" class="btn btn-sm btn-success" 
                                                    @(item.stock <= 0 ? "disabled" : "")>
                                                ➕
                                            </button>
                                        </div>
                                    </form>
                                </td>
                                <td>
                                    @if (item.stock <= 0)
                                    {
                                        <span class="badge bg-danger">Sin stock</span>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }

    <!-- Carrito y Promociones -->
    @if (listaProd != null && listaProd.Count > 0)
    {
        <div class="row">
            <!-- Productos en Carrito -->
            <div class="col-md-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h4>Productos en Carrito <span class="badge bg-primary">@listaProd.Count</span></h4>
                    </div>
                    <div class="card-body table-responsive">
                        <table class="table">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var prod in listaProd)
                                {
                                    <tr>
                                        <td><strong>@prod.nombre</strong></td>
                                        <td class="text-center">@prod.cantidad</td>
                                        <td class="text-end">S/. @prod.precio.ToString("F2")</td>
                                        <td class="text-end"><strong>S/. @(prod.cantidad * prod.precio).ToString("F2")</strong></td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot>
                                <tr class="table-light">
                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                    <td class="text-end"><strong class="text-primary">S/. @ViewBag.Total?.ToString("F2") ?? "0.00"</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Promociones Aplicadas -->
            <div class="col-md-4">
                @if (promociones != null && promociones.Count > 0)
                {
                    <div class="card border-success mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">🎉 Promociones Aplicadas</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                @foreach (var promo in promociones)
                                {
                                    <div class="list-group-item px-0">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h6 class="mb-1">
                                                    <span class="badge bg-success">@promo.descuento%</span>
                                                    @promo.titulo
                                                </h6>
                                                <small class="text-muted d-block">
                                                    @promo.descripcion
                                                </small>
                                                <small class="text-secondary">
                                                    Vigencia: @promo.fecha_Inicio.ToString("dd/MM/yyyy") - @promo.fecha_Fin.ToString("dd/MM/yyyy")
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <strong class="text-success">
                                                    -S/. @promo.precioDescontado.ToString("F2")
                                                </strong>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                            
                            <div class="alert alert-success mt-3 mb-0">
                                <strong>Descuento Total:</strong>
                                <br />
                                <h5 class="text-success mb-0">
                                    -S/. @(promociones.Sum(p => p.precioDescontado)).ToString("F2")
                                </h5>
                            </div>
                        </div>
                    </div>
                }
                else if (listaProd.Count > 0)
                {
                    <div class="alert alert-info">
                        <strong>ℹ️</strong> No hay promociones aplicables en este momento.
                    </div>
                }
            </div>
        </div>
    }

    <!-- Formulario de Registro de Venta -->
    <div class="card mt-4">
        <div class="card-header">
            <h4>Datos del Comprador</h4>
        </div>
        <div class="card-body">
            <form asp-action="Create" method="post">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="idVendedor" class="form-label">ID Vendedor</label>
                        <input asp-for="idVendedor" class="form-control" type="number" />
                        <span asp-validation-for="idVendedor" class="text-danger small"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="nombreComprador" class="form-label">Nombre del Comprador</label>
                        <input asp-for="nombreComprador" class="form-control" required />
                        <span asp-validation-for="nombreComprador" class="text-danger small"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="dniComprador" class="form-label">DNI</label>
                        <input asp-for="dniComprador" class="form-control" required />
                        <span asp-validation-for="dniComprador" class="text-danger small"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="correoComprador" class="form-label">Correo</label>
                        <input asp-for="correoComprador" class="form-control" type="email" />
                        <span asp-validation-for="correoComprador" class="text-danger small"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="telefonoComprador" class="form-label">Teléfono</label>
                        <input asp-for="telefonoComprador" class="form-control" />
                        <span asp-validation-for="telefonoComprador" class="text-danger small"></span>
                    </div>
                </div>

                @if (ViewBag.Error != null)
                {
                    <div class="alert alert-danger">
                        @ViewBag.Error
                    </div>
                }

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" 
                            @(listaProd == null || listaProd.Count == 0 ? "disabled" : "")>
                        <i class="bi bi-check-circle"></i> Registrar Venta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}